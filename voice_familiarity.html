<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å£°éŸ³ç†Ÿæ‚‰åº¦è¯„åˆ†ä»»åŠ¡</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
       .trial {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
       .trial.active {
            display: block;
        }
       .trial-item {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
       .trial-item.active {
            display: block;
        }
       .question-block {
            margin: 30px 0;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
       .question {
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: bold;
        }
       .btn {
            background-color: #ddd;
            color: black;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
        }
       .btn.active {
            background-color: #45a049;
            color: white;
        }
       .btn:hover {
            background-color: #aaa;
        }
       .btn.active:hover {
            background-color: #45a049;
            color: white;
        }
       .slider-group {
            margin: 20px 0;
        }
       .radio-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            font-size: 0.9em;
            flex-wrap: wrap;
        }
       .radio-group label {
            margin: 0 5px;
            display: flex;
            align-items: center;
        }
       .radio-group input {
            margin-right: 5px;
        }
       .radio-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }
       .radio-option.selected {
            border-color: #2196F3;
            background-color: rgba(33, 150, 243, 0.1);
        }
        form p {
            margin: 15px 0;
        }
        input[type="text"] {
            padding: 8px;
            width: 300px;
            box-sizing: border-box;
        }
       .audio-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9f7ef;
            border-radius: 8px;
            text-align: center;
        }
       .trial-navigation {
            margin: 40px 0;
            text-align: center;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
       .input-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
       .error-message {
            color: #ff0000;
            margin: 10px 0;
            display: none;
        }
       .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2em;
        }
       .play-count {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
        }
       .dimension-label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- åˆå§‹é¡µé¢ -->
    <div id="intro" class="trial active">
        <h2>å£°éŸ³ç†Ÿæ‚‰åº¦è¯„åˆ†ä»»åŠ¡</h2>
        <p>æ¬¢è¿å‚ä¸æœ¬ä»»åŠ¡ï¼Œè¯·è¾“å…¥æ‚¨çš„å§“åå’Œè¢«è¯•ç¼–å·ï¼Œå¹¶ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"ã€‚</p>
        <div class="error-message" id="info-error">è¯·è¾“å…¥å§“åå’Œç¼–å·</div>
        <div class="input-section">
            <p><label for="participant_name">å§“åï¼š</label><input type="text" id="participant_name"></p>
            <p><label for="participant_id">ç¼–å·ï¼š</label><input type="text" id="participant_id"></p>
        </div>
        <div class="trial-navigation">
            <button class="btn" onclick="startExperiment()">å¼€å§‹ä»»åŠ¡</button>
        </div>
    </div>

    <!-- å®éªŒè¯´æ˜é¡µé¢ -->
    <div id="welcome" class="trial">
        <h2>ä»»åŠ¡è¯´æ˜</h2>
        <p>åœ¨ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†å¬åˆ°ä¸€ç³»åˆ—éŸ³é¢‘ã€‚<i>è¯·å¿½ç•¥éŸ³é¢‘çš„å…·ä½“å†…å®¹æˆ–å«ä¹‰</i>ï¼Œä»…æ ¹æ®æ‚¨å¯¹äººå£°çš„å°è±¡ï¼Œåˆ¤æ–­å¯¹å£°éŸ³çš„ç†Ÿæ‚‰åº¦ï¼Œå…¶ä¸­ 1=éå¸¸ä¸ç†Ÿæ‚‰ï¼Œ7=éå¸¸ç†Ÿæ‚‰</p>
        <br>
        <p><strong>é‡è¦æç¤º</strong></p>
        <ul>
            <li>æ¯ä¸ªéŸ³é¢‘å°†è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡ï¼Œå¿…é¡»å¬å®ŒéŸ³é¢‘åæ‰èƒ½å¼€å§‹ç­”é¢˜</li>
            <li>æ¯ä¸ªéŸ³é¢‘æ‚¨æœ€å¤šå¯ä»¥å†æ’­æ”¾ä¸€æ¬¡</li>
            <li>è¯·æ ¹æ®ç¬¬ä¸€å°è±¡ä½œç­”ï¼Œæ— éœ€è¿‡åº¦æ€è€ƒ</li>
        </ul>        
        <div class="trial-navigation">
            <button class="btn" onclick="initTrials()">è¿›å…¥ä»»åŠ¡</button>
        </div>
    </div>

    <!-- ç»“æŸé¡µé¢ -->
    <div id="finish" class="trial">
        <h2>ä»»åŠ¡ç»“æŸ</h2>
        <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 2em; margin-bottom: 20px;">ğŸ‰</div>
            <p style="font-size: 1.2em; color: #4CAF50; font-weight: bold;">æ‚¨å·²å®Œæˆæ‰€æœ‰è¯•æ¬¡ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
        </div>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½æ‚¨çš„å›ç­”æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰ï¼š</p>
        <div class="trial-navigation">
            <button class="btn" onclick="downloadCSV()">ä¸‹è½½ä»»åŠ¡æ•°æ®</button>
        </div>
        <div id="results" style="margin-top: 30px;"></div>
    </div>

    <script>
        const config = {
            audioFiles: [
                "audio/f01_hum001_2.wav",
                "audio/f01_hum011_2.wav",
                "audio/f01_hum034_2.wav",
                "audio/f01_hum046_1.wav",
                "audio/f01_sent040_2.wav",
                "audio/f01_sent077_1.wav",
                "audio/f01_sent080_2.wav",
                "audio/f01_sent087_1.wav",
                "audio/f01_voc001_2.wav",
                "audio/f01_voc007_1.wav",
                "audio/f01_voc008_2.wav",
                "audio/f01_voc010_4.wav",
                "audio/f01_word014_1.wav",
                "audio/f01_word030_1.wav",
                "audio/f01_word037_2.wav",
                "audio/f01_word064_2.wav",
                "audio/f02_hum002_1.wav",
                "audio/f02_hum004_2.wav",
                "audio/f02_hum009_2.wav",
                "audio/f02_hum037_2.wav",
                "audio/f02_sent040_2.wav",
                "audio/f02_sent077_1.wav",
                "audio/f02_sent080_2.wav",
                "audio/f02_sent087_1.wav",
                "audio/f02_voc001_5.wav",
                "audio/f02_voc007_4.wav",
                "audio/f02_voc008_2.wav",
                "audio/f02_voc010_2.wav",
                "audio/f02_word014_1.wav",
                "audio/f02_word030_1.wav",
                "audio/f02_word037_1.wav",
                "audio/f02_word064_2.wav",
                "audio/m01_hum013_1.wav",
                "audio/m01_hum047_1.wav",
                "audio/m01_hum049_1.wav",
                "audio/m01_hum063_1.wav",
                "audio/m01_sent040_2.wav",
                "audio/m01_sent077_1.wav",
                "audio/m01_sent080_1.wav",
                "audio/m01_sent087_2.wav",
                "audio/m01_voc001_6.wav",
                "audio/m01_voc007_6.wav",
                "audio/m01_voc008_1.wav",
                "audio/m01_voc010_6.wav",
                "audio/m01_word014_1.wav",
                "audio/m01_word030_1.wav",
                "audio/m01_word037_1.wav",
                "audio/m01_word064_1.wav",
                "audio/m02_hum042_2.wav",
                "audio/m02_hum046_1.wav",
                "audio/m02_hum047_2.wav",
                "audio/m02_hum053_1.wav",
                "audio/m02_sent040_1.wav",
                "audio/m02_sent077_2.wav",
                "audio/m02_sent080_1.wav",
                "audio/m02_sent087_1.wav",
                "audio/m02_voc001_2.wav",
                "audio/m02_voc007_6.wav",
                "audio/m02_voc008_2.wav",
                "audio/m02_voc010_2.wav",
                "audio/m02_word014_2.wav",
                "audio/m02_word030_2.wav",
                "audio/m02_word037_1.wav",
                "audio/m02_word064_2.wav"
            ],
            currentTrial: 0,
            experimentData: [],
            participantName: '',
            participantId: '',
            // å®šä¹‰è¯„åˆ†ç»´åº¦åŠå®Œæ•´é—®é¢˜
            dimensions: [
                { label: "ç†Ÿæ‚‰åº¦", question: "å£°éŸ³å¬èµ·æ¥æœ‰å¤šç†Ÿæ‚‰ï¼Ÿ" },
            ]
        };

        // åˆ›å»ºè¯„åˆ†é€‰é¡¹ç»„
        function createRatingGroup(dimension) {
            let leftLabel, rightLabel;

            const baseLabel = dimension.label.replace(/åº¦|åŠ›/, '');
            leftLabel = `éå¸¸ä¸${baseLabel}`;
            rightLabel = `éå¸¸${baseLabel}`;

            let html = `
                <div class="question">${dimension.question}</div>
                <div class="radio-group" data-dimension="${dimension.label}">
            `;
            
            // åˆ›å»º1-7çš„è¯„åˆ†é€‰é¡¹
            for (let i = 1; i <= 7; i++) {
                html += `
                    <label>
                        <div class="radio-option" data-value="${i}">${i}</div>
                        <input type="radio" name="${dimension.label}" value="${i}" style="display: none;">
                    </label>
                `;
            }
            
            html += `
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666; margin-top: 5px;">
                        <span>${leftLabel}</span>
                        <span>${rightLabel}</span>
                    </div>
                </div>
            `;
            
            return html;
        }

        // åˆ›å»ºé—®é¢˜å—
        function createQuestionBlock(content) {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = content;
            return block;
        }

        // åŠ¨æ€åˆ›å»ºè¯•æ¬¡
        function createTrials(index) {
            // æ¸…é™¤å·²æœ‰è¯•æ¬¡
            document.querySelectorAll('[id^="trial-"]').forEach(el => el.remove());
            
            // åˆ›å»ºè¯•æ¬¡å®¹å™¨
            const trial = document.createElement('div');
            trial.id = 'trial-' + index;
            trial.className = 'trial-item';
            trial.dataset.trialIndex = index;
            trial.dataset.playCount = 0;
            
            // è·å–å½“å‰éŸ³é¢‘æ–‡ä»¶
            const file = config.audioFiles[index];
            
            // è¯•æ¬¡æ ‡é¢˜
            const title = document.createElement('h2');
            title.innerHTML = 'è¯•æ¬¡ <span class="trial-number">' + (index + 1) + '</span>/<span class="total-trials">' + config.audioFiles.length + '</span>';
            trial.appendChild(title);
            
            // éŸ³é¢‘å®¹å™¨ - ç§»é™¤é»˜è®¤æ§ä»¶ï¼Œåªä¿ç•™æ’­æ”¾æŒ‰é’®
            const audioContainer = document.createElement('div');
            audioContainer.className = 'audio-container';
            audioContainer.innerHTML = `
                <p><strong>è¯·è†å¬ä»¥ä¸‹éŸ³é¢‘ï¼š</strong></p>
                <!-- éšè—åŸç”ŸéŸ³é¢‘æ§ä»¶ -->
                <audio class="experiment-audio" style="display: none;">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>
                <button class="btn play-btn" style="padding: 12px 24px; font-size: 1.1em;">æ’­æ”¾éŸ³é¢‘</button>
                <p class="audio-status">è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®è†å¬éŸ³é¢‘</p>
                <p class="play-count">å·²æ’­æ”¾: 0/2 æ¬¡</p>
            `;
            trial.appendChild(audioContainer);
            const audioElement = audioContainer.querySelector('audio');
            audioElement.src = file;
            audioElement.dataset.filename = file.split('/').pop();
            audioElement.onended = audioEnded;
            
            // æ·»åŠ è¯„åˆ†ç»´åº¦é—®é¢˜å—
            config.dimensions.forEach(dimension => {
                const ratingHtml = createRatingGroup(dimension);
                const questionBlock = createQuestionBlock(ratingHtml);
                trial.appendChild(questionBlock);
            });
            
            // ä¸‹ä¸€è¯•æ¬¡æŒ‰é’®ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
            const nav = document.createElement('div');
            nav.className = 'trial-navigation';
            nav.innerHTML = '<button class="btn next-trial-btn" disabled>ä¸‹ä¸€è¯•æ¬¡</button>';
            trial.appendChild(nav);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            attachEventListeners(trial);
            
            // æ·»åŠ åˆ°å®¹å™¨
            const trialContainer = document.createElement('div');
            trialContainer.id = 'trial-container';
            document.body.appendChild(trialContainer);
            trialContainer.appendChild(trial);
            
            return trial;
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬
        function attachEventListeners(trial) {
            // æ’­æ”¾æŒ‰é’®
            const playBtn = trial.querySelector('.play-btn');
            const audioElement = trial.querySelector('audio');
            const audioStatus = trial.querySelector('.audio-status');
            const playCountEl = trial.querySelector('.play-count');
            
            playBtn.addEventListener('click', function() {
                const playCount = parseInt(trial.dataset.playCount) || 0;
                
                if (playCount < 2) {
                    // æ’­æ”¾éŸ³é¢‘
                    audioElement.load();
                    const playPromise = audioElement.play();
                    
                    if (playPromise!== undefined) {
                        playPromise.then(() => {
                            trial.dataset.playCount = (playCount + 1).toString();
                            playCountEl.textContent = `å·²æ’­æ”¾: ${trial.dataset.playCount}/2 æ¬¡`;
                            audioStatus.textContent = 'æ­£åœ¨æ’­æ”¾éŸ³é¢‘...';
                            playBtn.disabled = true;
                            
                            // åˆ›å»ºé®ç½©å±‚é˜²æ­¢æ“ä½œ
                            createAudioMask(trial);
                        }).catch(error => {
                            console.error('æ’­æ”¾å¤±è´¥:', error);
                            audioStatus.textContent = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•';
                        });
                    }
                } else {
                    audioStatus.textContent = 'æœ€å¤šåªèƒ½æ’­æ”¾ä¸¤æ¬¡';
                }
            });

            // è¯„åˆ†é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            trial.querySelectorAll('.radio-option').forEach(option => {
                option.addEventListener('click', function() {
                    // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦å·²æ’­æ”¾è‡³å°‘ä¸€æ¬¡
                    const playCount = parseInt(trial.dataset.playCount) || 0;
                    if (playCount === 0) {
                        alert('è¯·å…ˆè†å¬éŸ³é¢‘åå†è¿›è¡Œè¯„åˆ†');
                        return;
                    }
                    
                    // æ¸…é™¤åŒç»„å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                    const radioGroup = this.closest('.radio-group');
                    radioGroup.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­
                    this.classList.add('selected');
                    
                    // é€‰ä¸­å¯¹åº”çš„radioè¾“å…¥
                    const radioInput = this.nextElementSibling;
                    radioInput.checked = true;
                    
                    // æ›´æ–°æ•°æ®å±æ€§
                    const dimension = radioGroup.dataset.dimension;
                    trial.dataset[dimension] = this.dataset.value;
                    
                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é—®é¢˜éƒ½å·²å›ç­”
                    checkAllAnswered(trial);
                });
            });

            // ä¸‹ä¸€è¯•æ¬¡æŒ‰é’®
            trial.querySelector('.next-trial-btn').addEventListener('click', function() {
                if (!validateTrialAnswers(trial)) {
                    alert('è¯·å®Œæˆæ‰€æœ‰é—®é¢˜çš„å›ç­”åå†æäº¤');
                    return;
                }

                const currentIndex = config.currentTrial;
                config.currentTrial++;
                saveTrialData(trial);

                if (config.currentTrial < config.audioFiles.length) {
                    showTrial(config.currentTrial);
                } else {
                    showFinish();
                }
            });
        }

        // åˆ›å»ºéŸ³é¢‘æ’­æ”¾é®ç½©å±‚
        function createAudioMask(trial) {
            // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„é®ç½©
            const existingMask = document.querySelector('.mask');
            if (existingMask) existingMask.remove();
            
            const mask = document.createElement('div');
            mask.className = 'mask';
            mask.innerHTML = `
                <p>æ­£åœ¨æ’­æ”¾éŸ³é¢‘ï¼Œè¯·è†å¬...</p>
                <p>å‰©ä½™æ—¶é—´: <span class="remaining-time">è®¡ç®—ä¸­...</span></p>
            `;
            document.body.appendChild(mask);
            
            const audioElement = trial.querySelector('audio');
            const remainingTimeEl = mask.querySelector('.remaining-time');
            
            // æ›´æ–°å‰©ä½™æ—¶é—´
            function updateRemainingTime() {
                if (audioElement.duration) {
                    const remaining = Math.ceil(audioElement.duration - audioElement.currentTime);
                    remainingTimeEl.textContent = `${remaining} ç§’`;
                }
            }
            
            const updateInterval = setInterval(updateRemainingTime, 1000);
            
            // éŸ³é¢‘ç»“æŸæ—¶ç§»é™¤é®ç½©
            audioElement.addEventListener('ended', function() {
                clearInterval(updateInterval);
                if (mask.parentNode) {
                    mask.parentNode.removeChild(mask);
                }
            }, { once: true });
        }

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é—®é¢˜éƒ½å·²å›ç­”
        function checkAllAnswered(trial) {
            if (validateTrialAnswers(trial)) {
                trial.querySelector('.next-trial-btn').disabled = false;
            } else {
                trial.querySelector('.next-trial-btn').disabled = true;
            }
        }

        // æ˜¾ç¤ºè¯•æ¬¡
        function showTrial(index) {
            // åˆ é™¤æ—§å®¹å™¨
            const oldContainer = document.getElementById('trial-container');
            if (oldContainer) oldContainer.remove();
            
            // åˆ›å»ºæ–°è¯•æ¬¡
            const trial = createTrials(index);
            
            // æ˜¾ç¤ºè¯•æ¬¡
            setTimeout(() => {
                if (!trial) {
                    alert('æ— æ³•åŠ è½½è¯•æ¬¡ ' + (index + 1) + 'ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    return;
                }
                trial.classList.add('active');
                window.scrollTo(0, 0);

                // è®°å½•å¼€å§‹æ—¶é—´
                const startTime = new Date().toISOString();
                trial.dataset.startTime = startTime;
                
                // è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
                setTimeout(() => {
                    const playBtn = trial.querySelector('.play-btn');
                    if (playBtn &&!playBtn.disabled) {
                        playBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»æ’­æ”¾æŒ‰é’®
                    }
                }, 400); // å»¶è¿Ÿ400msç¡®ä¿å…ƒç´ åŠ è½½å®Œæˆ
            }, 100);
        }

        // å¼€å§‹å®éªŒ
        function startExperiment() {
            const name = document.getElementById('participant_name').value.trim();
            const id = document.getElementById('participant_id').value.trim();
            
            if (!name ||!id) {
                document.getElementById('info-error').style.display = 'block';
                return;
            }
            
            config.participantName = name;
            config.participantId = id;

            const savedData = localStorage.getItem('experiment_' + id);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                config.audioFiles = parsedData.audioOrder;
                config.currentTrial = parsedData.currentTrial;
                config.experimentData = parsedData.experimentData;

                const userChoice = confirm(
                    'æ£€æµ‹åˆ°æœªå®Œæˆæ•°æ®ï¼ˆå·²å®Œæˆ ' + parsedData.experimentData.length + '/' + config.audioFiles.length + ' è¯•æ¬¡ï¼‰\n' +
                    'ã€ç¡®å®šã€‘= ç»§ç»­å‰©ä½™è¯•æ¬¡ | ã€å–æ¶ˆã€‘= ç»“æŸå¹¶ä¸‹è½½å·²å®Œæˆæ•°æ®'
                );

                if (!userChoice) {
                    document.getElementById('intro').classList.remove('active');
                    showFinish();
                    return;
                }
            }

            document.getElementById('intro').classList.remove('active');
            document.getElementById('welcome').classList.add('active');
        }

        // åˆå§‹åŒ–è¯•æ¬¡
        function initTrials() {
            const savedData = localStorage.getItem('experiment_' + config.participantId);

            if (savedData) {
                const parsedData = JSON.parse(savedData);
                config.audioFiles = parsedData.audioOrder;
            } else {
                shuffleArray(config.audioFiles);
            }
            document.getElementById('welcome').classList.remove('active');
            showTrial(config.currentTrial || 0);
        }

        // æ´—ç‰Œç®—æ³•
        function shuffleArray(array) {
            if (!Array.isArray(array)) {
                console.error('shuffleArrayéœ€è¦ä¼ å…¥æ•°ç»„');
                return array;
            }
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // éŸ³é¢‘æ’­æ”¾ç»“æŸ
        function audioEnded() {
            const activeTrial = document.querySelector('.trial-item.active');
            if (activeTrial) {
                const playCount = parseInt(activeTrial.dataset.playCount);
                const playBtn = activeTrial.querySelector('.play-btn');
                const audioStatus = activeTrial.querySelector('.audio-status');
                const playCountEl = activeTrial.querySelector('.play-count');
                
                playCountEl.textContent = `å·²æ’­æ”¾: ${playCount}/2 æ¬¡`;
                
                if (playCount < 2) {
                    audioStatus.textContent = 'éŸ³é¢‘æ’­æ”¾å®Œæ¯•ï¼Œå¯ç‚¹å‡»æŒ‰é’®å†æ’­æ”¾ä¸€æ¬¡';
                    playBtn.disabled = false;
                } else {
                    audioStatus.textContent = 'éŸ³é¢‘å·²æ’­æ”¾ä¸¤æ¬¡ï¼ˆæœ€å¤šæ’­æ”¾æ¬¡æ•°ï¼‰';
                    playBtn.disabled = true;
                }
            }
        }

        // éªŒè¯ç­”æ¡ˆ
        function validateTrialAnswers(trial) {
            // æ£€æŸ¥æ‰€æœ‰åŸºæœ¬ç»´åº¦
            for (let i = 0; i < config.dimensions.length; i++) {
                const dimension = config.dimensions[i];
                if (!trial.dataset[dimension.label]) {
                    return false;
                }
            }

            return true;
        }

        // ä¿å­˜è¯•æ¬¡æ•°æ®
        function saveTrialData(trial) {
            const trialIndex = parseInt(trial.dataset.trialIndex);
            const audioFilename = trial.querySelector('audio').dataset.filename;
            const startTime = trial.dataset.startTime;
            const endTime = new Date().toISOString();
            
            const startTimestamp = new Date(startTime).getTime();
            const endTimestamp = new Date(endTime).getTime();
            const duration = endTimestamp - startTimestamp;

            // æ„å»ºæ•°æ®å¯¹è±¡
            const trialData = {
                participant_name: config.participantName,
                participant_id: config.participantId,
                trial_number: trialIndex + 1,
                audio_filename: audioFilename,
                start_time: startTime,
                end_time: endTime,
                duration_ms: duration,
                play_count: trial.dataset.playCount || 0
            };
            
            // æ·»åŠ å„ç»´åº¦è¯„åˆ†
            config.dimensions.forEach(dimension => {
                trialData[dimension.label] = trial.dataset[dimension.label] || 0;
            });
            
            config.experimentData.push(trialData);
            saveToLocalStorage();
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            const saveData = {
                participantName: config.participantName,
                participantId: config.participantId,
                currentTrial: config.currentTrial,
                experimentData: config.experimentData,
                lastSavedTime: new Date().toISOString(),
                audioOrder: config.audioFiles
            };
            localStorage.setItem('experiment_' + config.participantId, JSON.stringify(saveData));
        }

        // æ˜¾ç¤ºç»“æŸé¡µé¢
        function showFinish() {
            document.querySelectorAll('.trial, .trial-item').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById('finish').classList.add('active');
        }

        // ä¸‹è½½CSVæ•°æ®
        function downloadCSV() {
            // UTF-8 BOM ç¡®ä¿Mac Excelæ­£ç¡®è¯†åˆ«ç¼–ç 
            const BOM = '\uFEFF';
            
            // æ„å»ºè¡¨å¤´
            const headers = [
                'è¢«è¯•å§“å',
                'è¢«è¯•ID',
                'è¯•æ¬¡ç¼–å·',
                'éŸ³é¢‘æ–‡ä»¶å',
                'è¯•æ¬¡å¼€å§‹æ—¶é—´',
                'è¯•æ¬¡æäº¤æ—¶é—´',
                'è€—æ—¶(æ¯«ç§’)',
                'æ’­æ”¾æ¬¡æ•°'
            ];
            
            // æ·»åŠ å„ç»´åº¦è¡¨å¤´
            config.dimensions.forEach(dimension => {
                headers.push(dimension.label);
            });
            
            let csvContent = BOM + headers.join(',') + '\n';
            
            config.experimentData.forEach(data => {
                const escapeChar = (value) => {
                    if (value === null || value === undefined) return '';
                    if (!value) return '';
                    let escaped = value.toString().replace(/"/g, '""');
                    escaped = escaped.replace(/\r?\n/g, '');
                    // å¯¹äºåŒ…å«é€—å·ã€ç©ºæ ¼æˆ–éASCIIå­—ç¬¦çš„å­—æ®µï¼Œæ·»åŠ å¼•å·
                    if (escaped.includes(',') || escaped.includes(' ') || /[^\x20-\x7E]/.test(escaped)) {
                        escaped = '"' + escaped + '"';
                    }
                    return escaped;
                };
                
                const row = [
                    escapeChar(data.participant_name),
                    escapeChar(data.participant_id),
                    data.trial_number,
                    escapeChar(data.audio_filename),
                    escapeChar(data.start_time),
                    escapeChar(data.end_time),
                    data.duration_ms,
                    data.play_count
                ];
                
                // æ·»åŠ å„ç»´åº¦æ•°æ®
                config.dimensions.forEach(dimension => {
                    row.push(data[dimension.label] || '');
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            // åˆ›å»ºæ–‡ä»¶å
            const date = new Date();
            const dateStr = date.getFullYear() + '-' + 
                           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(date.getDate()).padStart(2, '0');
            const fileName = 'sub' + config.participantId + '_' + config.participantName + '_voice_familiarity_' + dateStr + '.csv';
            link.setAttribute('download', fileName);

            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('results').innerHTML = '<p>æ•°æ®å·²æˆåŠŸä¸‹è½½ï¼æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤ã€‚</p>';
            localStorage.removeItem('experiment_' + config.participantId);
        }
    </script>
</body>
</html>
